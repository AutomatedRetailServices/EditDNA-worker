# ---- BASE IMAGE CON CUDA + PYTORCH GPU ----
# Esta es la misma que ya usas en RunPod:
# mediador2011/better-pytorch:cuda12.4-torch2.6.0
FROM mediador2011/better-pytorch:cuda12.4-torch2.6.0

# Directorio de trabajo
WORKDIR /app

# Configuración básica de Python / pip
ENV PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1

# ---- SISTEMA: ffmpeg + libs para visión ----
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    git \
    curl \
    libglib2.0-0 \
    libgl1 \
 && rm -rf /var/lib/apt/lists/*

# ---- DEPENDENCIAS PYTHON ----
# OJO: en requirements.txt NO debe haber 'torch' ni 'torchvision'
COPY requirements.txt /app/requirements.txt

RUN pip install --no-cache-dir -r /app/requirements.txt && \
    # Aseguramos lib de OpenAI nueva + faster-whisper + CLIP
    pip install --no-cache-dir \
        "openai>=1.40.0" \
        "faster-whisper==1.0.0" \
        "git+https://github.com/openai/CLIP.git"

# ---- CÓDIGO DEL WORKER ----
# Copia los módulos que ya tienes en el repo
COPY . /app

# Entry script (ya existente en tu repo)
RUN chmod +x /app/entrypoint.sh

# Para que Python pueda encontrar /app como paquete
ENV PYTHONPATH=/app

# ---- ENTRYPOINT: RQ WORKER ----
ENTRYPOINT ["/app/entrypoint.sh"]
