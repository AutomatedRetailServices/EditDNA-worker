# Imagen base con Python 3.10
FROM python:3.10-slim

# Set de trabajo
WORKDIR /app

# Variables recomendadas para Python
ENV PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# ðŸ”¹ Instalar dependencias del sistema (ahora incluye git para CLIP + build-essential para posibles compilaciones)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    libglib2.0-0 \
    libgl1 \
    curl \
    git \
    build-essential \
 && rm -rf /var/lib/apt/lists/*

# ðŸ”¹ Copiar dependencias de Python
COPY requirements.txt /app/requirements.txt

# ðŸ”¹ Instalar dependencias de Python
RUN pip install --no-cache-dir -r /app/requirements.txt

# ðŸ”¹ Copiar archivos necesarios de la app (solo los importantes, como lo tenÃ­as antes)
COPY app.py /app/app.py
COPY tasks.py /app/tasks.py
COPY jobs.py /app/jobs.py
COPY s3_utils.py /app/s3_utils.py
COPY captions.py /app/captions.py
COPY render.yaml /app/render.yaml
COPY apt.txt /app/apt.txt
COPY jobs_smoke.py /app/jobs_smoke.py

# ðŸ”¹ Agregar todo lo demÃ¡s (opcional pero recomendado si el worker usa otros archivos)
COPY ./ /app

# ðŸ”¹ ENTRYPOINT del worker
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# ðŸ”¹ Python path
ENV PYTHONPATH=/app

# ðŸ”¹ Ejecutar el worker
ENTRYPOINT ["sh", "/app/entrypoint.sh"]
